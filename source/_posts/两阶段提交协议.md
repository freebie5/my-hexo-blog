---
title: 两阶段提交协议
date: 2020-08-02 21:21:46
tags: 
- 两阶段提交
- 三阶段提交
- 分布式事务
categories: 分布式相关
---

## 1.两阶段提交协议（2PC，Two-phase Commit）

2PC将分布式事务拆分成2个阶段：**准备阶段（Prepare phase）**和**提交阶段（Commit phase）**

整个事务过程由一个**协调者**和多个**参与者**组成。

协调者负责接收参与者发起的事务请求，向所有参与者发起投票，收集投票结果，做出commit或者rollback决定，并将决定通知给参与者。

参与者负责监听来自协调者的投票请求，以及最后的决定，一旦协调者的决定是rollback，所有参与者都必须回滚本地事务，否则所有参与者都提交本地事务。

### 准备阶段（Prepare phase）

1）协调者向所有的参与者发送投票请求，并等待参与者反馈事务执行结果；

2）事务参与者收到请求之后，执行事务但不提交，并记录事务日志（Undo日志和Redo日志，Undo日志是记录修改前的数据，用于数据库回滚，Redo日志是记录修改后的数据，用于提交事务后写入数 据文件）；

3）参与者将自己事务执行情况反馈给协调者，同时阻塞等待协调者的后续指令。

### 提交阶段（Commit phase）

在经过第一阶段协调者的询盘之后，各个参与者会回复自己事务的执行情况，这时候存在 3 种可能性：

1）所有的参与者都回复能够正常执行事务；

2）一个或多个参与者回复事务执行失败；

3）协调者等待超时。（超时原因有两个可能：一是协调者发起的投票请求没有送达参与者，二是参与者的响应没有送到协调者）

**对于第 1 种情况，协调者将向所有的参与者发出提交事务的通知，具体步骤如下：**

1）协调者向各个参与者发送 commit 通知，请求提交事务；

2）参与者收到事务提交通知之后执行 commit 操作，然后释放占有的资源；

3）参与者向协调者返回事务 commit 结果信息。

<p><img src="/assets/blogImg/两阶段提交协议_01.png" width="600"></p>

**对于第 2 和第 3 种情况，协调者均认为参与者无法成功执行事务，为了整个集群数据的一致性，所以要向各个参与者发送事务回滚通知，具体步骤如下：**

1）协调者向各个参与者发送事务 rollback 通知，请求回滚事务；

2）参与者收到事务回滚通知之后执行 rollback 操作，然后释放占有的资源；

3）参与者向协调者返回事务 rollback 结果信息。

<p><img src="/assets/blogImg/两阶段提交协议_02.png" width="600"></p>

### 网络超时导致的问题探讨

| 阶段     | 被网络超时影响的操作                                | 协调者受影响               | 参与者受影响                                                 |
| -------- | --------------------------------------------------- | -------------------------- | ------------------------------------------------------------ |
| 准备阶段 | 参与者没有收到协调者的投票请求                      | 等待超时，发送rollback通知 | 无影响                                                       |
| 准备阶段 | 协调者没有收到参与者的事务执行请求的应答            | 等待超时，发送rollback通知 | 同步阻塞；                                                   |
| 提交阶段 | 参与者没有收到协调者的 commit通知 或者 rollback通知 | 等待超时，发送rollback通知 | 1）同步阻塞；2）如果部分参与收到通知，部分参与者收不到通知，则数据不一致 |
| 提交阶段 | 协调者没有收到参与者的 commit结果 或者 rollback结果 | 无影响                     | 无影响                                                       |

### 2PC的缺点

1）单点问题

协调者在整个两阶段提交过程中扮演着举足轻重的作用，一旦协调者所在服务器宕机，就会影响整个数据库集群的正常运行。比如在第二阶段中，如果协调者因为故障不能正常发送事务提交或回滚通知，那么参与者们将一直处于阻塞状态，整个数据库集群将无法提供服务。

2）同步阻塞

在准备阶段，参与者向协调者发送事务执行情况之后，就会阻塞等待协调者的后续指令。

3）数据不一致

两阶段提交协议虽然是为分布式数据强一致性所设计，但仍然存在数据不一致性的可能性。比如在第二阶段中，假设协调者发出了事务 commit 通知，但是因为网络问题该通知仅被一部分参与者所收到并执行了commit 操作，其余的参与者则因为没有收到通知一直处于阻塞状态，这时候就产生了数据的不一致性。

## 2.三阶段提交协议（3PC，Three-phase Commit）

针对两阶段提交存在的问题，三阶段提交协议将流程分为三阶段，并且参与者也引入了超时机制，包含如下三个阶段：canCommit，preCommit，doCommit

### canCommit阶段

1）协调者向各个参与者发送canCommit请求，询问是否可以执行事务操作，并等待回复；

2）各个参与者依据自身状况回复一个预估值，如果预估自己能够正常执行事务就返回确定信息，并进入preCommit阶段，否则返回否定信息。

### preCommit阶段

本阶段协调者会根据canCommit阶段参与者的响应结果采取相应操作，结果主要有 3 种：

1）所有的参与者都返回确定信息。

2）一个或多个参与者返回否定信息。

3）协调者等待超时。（超时原因有两个可能：一是协调者发起的canCommit请求没有送达参与者，二是参与者的canCommit响应没有送到协调者）

**针对第 1 种情况，协调者会向所有参与者发送事务preCommit请求，具体步骤如下：**

1）协调者向所有的事务参与者发送事务preCommit请求；

2）参与者收到preCommit请求后执行事务但不提交；如果收不到preCommit请求，则中断事务；

3）参与者将事务执行情况返回给协调者。

**针对第 2 和第 3 种情况，协调者认为事务无法正常执行，于是向各个参与者发出abort通知，请求退出预备状态，具体步骤如下：**

1）协调者向所有事务参与者发送abort通知；

2）参与者收到通知后中断事务。

<p><img src="/assets/blogImg/两阶段提交协议_03.png" width="750"></p>

### doCommit阶段

如果第二阶段事务未中断，那么本阶段协调者将会依据事务执行返回的结果来决定提交或回滚事务，分为 3 种情况：

1）所有的参与者都能正常执行事务；

2）一个或多个参与者执行事务失败；

3）协调者等待超时。

**针对第 1 种情况，协调者向各个参与者发起doCommit请求，具体步骤如下：**

1）协调者向所有参与者发送doCommit请求；

2）所有参与者在收到doCommit请求之后执行提交事务，并释放占有的资源；

3）参与者向协调者反馈事务提交结果。

<p><img src="/assets/blogImg/两阶段提交协议_04.png" width="600"></p>

**针对第 2 和第 3 种情况，协调者认为事务无法成功执行，于是向各个参与者发送rollback请求，具体步骤如下：**

1）协调者向所有参与者发送事务rollback通知；

2）所有参与者在收到通知之后执行回滚事务，并释放占有的资源；

3）参与者向协调者反馈事务回滚结果。

<p><img src="/assets/blogImg/两阶段提交协议_05.png" width="600"></p>

在本阶段如果因为协调者或网络问题，导致参与者迟迟不能收到来自协调者的commit或rollback请求，那么参与者将不会如两阶段提交中那样陷入阻塞，而是等待超时后继续commit，相对于两阶段提交虽然降低了同步阻塞，但仍然无法完全避免数据的不一致。

### 网络超时导致的问题探讨

| 阶段      | 被网络超时影响的操作            | 协调者受影响              | 参与者受影响       |
| --------- | ------------------------------- | ------------------------- | ------------------ |
| canCommit | 参与者没有收到事务canCommit通知 | 等待超时，发送 abort 通知 | 无影响             |
| canCommit | 协调者没有收到事务canCommit响应 | 等待超时，发送 abort 通知 | 等待超时，中断事务 |
| canCommit | 参与者没有收到事务abort通知     | 无影响                    | 等待超时，中断事务 |
| preCommit | 参与者没有收到事务preCommit通知 | 等待超时，发送abort通知   | 等待超时，中断事务 |
| preCommit | 协调者没有收事务到preCommit响应 | 等待超时，发送abort通知   | 等待超时，提交事务 |
| preCommit | 参与者没有收到事务abort通知     | 无影响                    | 等待超时，提交事务 |
| doCommit  | 参与者没有收到事务doCommit通知  | 无影响                    | 等待超时，提交事务 |
| doCommit  | 协调者没有收到事务doCommit响应  | 无影响                    | 无影响             |

### 3PC的缺点

数据不一致

仍然存在数据不一致问题，例如，第三阶段协调者发出了rollback通知，但是由于网络原因，部分参与者没有收到rollback通知，就会产生数据不一致问题

## 3.对比

3PC解决单点问题和同步阻塞问题，但是没有解决数据不一致问题

## 4.引用

https://segmentfault.com/a/1190000012534071

https://www.cnblogs.com/heliusKing/p/12122145.html

https://www.cnblogs.com/segeon/p/10381122.html