---
title: JVM之安全点和安全区域
date: 2020-08-22 22:29:09
tags: 
- JVM
- 安全点
- 安全区域
categories: JVM相关
---

## 什么是OopMap

目前主流的JVM（例如，Hot Spot）使用的都是**准确式内存管理**。什么是准确式内存管理？简单讲就是JVM知道内存中某个位置的数据是什么类型。例如，内存中有一个32位的整数123456，他到底是一个reference类型指向123456的内存地址，还是一个数值位123456的整数，JVM通过准确式内存管理能够分辨出来。

在Hot Spot的实现中，使用一组称为**OopMap**的数据结构类实现准确式内存管理。OopMap存储的数据包括：

1）在类加载完成的时候，Hot Spot就把对象内什么偏移量上是什么类型的数据计算出来；

2）在JIT编译过程中，也会在特定的位置记录下栈和寄存器中哪些位置是引用。

在OopMap的协助下，Hot Spot可以快速且准确地完成GC Roots枚举。

## 安全点（Safepoint）

什么是安全点？

JVM在特定的位置停下来进行GC，这个特定的位置就是**安全点**。选定安全点有2个关键的点要注意：

1）安全点的选定既不能太少以至于让GC等待时间太长，也不能过于频繁以至于过分增大运行时的负荷，所以，安全点的选定基本上是以程序**是否具有让程序长时间执行的特征**为标准进行选定的。**长时间执行**的最明显特征就是指令序列复用，例如：方法调用，循环跳转，异常跳转等。

2）如何在GC发送时让所有线程都执行到最近的安全点上再停顿下来。一般有2个方案：**抢先式中断**和**主动式中断**。

**抢先式中断**不需要线程的执行代码去主动配合，在GC发送时，首先把所有线程中断，如果发现有线程中断的地方不在安全点上，就恢复线程，然它继续执行到安全点上。（几乎没用虚拟机采用）

**主动式中断**在GC发生时，不直接对线程操作，仅仅简单地设置一个标志，各个线程执行时主动去**轮询**这个标志，线程发现中断标志为真时就自己中断挂起。**线程轮询的地方和安全点是重合的**。

## 安全区域（Safe Region）

**安全点**解决了线程**执行时**在不太长的时间内就可以进行GC。但是，当线程**不执行时**（例如：WAITING状态，BLOCKED状态）无法让线程继续执行到安全点。这个时候就需要**安全区域**了。

什么是安全区域？

安全区域指在一段代码片段之中，引用关系不会发生变化。在这个区域中的任意地方进行GC都是安全的。

安全区域机制如下：

1）在线程执行到安全区域中的代码时，首先标识自己已经进入安全区域，当在这段时间里JVM进行GC时，就不用管标识自己为安全区域的线程了；

2）当线程要离开安全区域时，线程检查JVM是否已经完成GC Root枚举，如果完成了，那线程就继续执行，否则，线程就必须等待直到收到可以安全离开安全区域的信号为止。